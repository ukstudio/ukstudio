{"componentChunkName":"component---src-templates-blog-post-js","path":"/posts//2014/09/05/arel/","result":{"data":{"site":{"siteMetadata":{"title":"UKSTUDIO BLOG"}},"markdownRemark":{"id":"829a39f7-f7e6-5e15-84fd-de16e83389e5","excerpt":"Model.arel_table を読みづらいと感じる 例えばこういうコード。 発行されるSQLはこんな感じ。 こちらの方が個人的には読みやすい。 問題もある テーブル名を変えてしまったとき 仮にテーブル名がかわったら後者の場合はエラーになる。 前者はモデルの方でテーブル名を変更すれば動作する。 scopeでmerge…","html":"<h2>Model.arel_table を読みづらいと感じる</h2>\n<p>例えばこういうコード。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">Post</span><span class=\"token punctuation\">.</span>joins<span class=\"token punctuation\">(</span><span class=\"token symbol\">:comments</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>order<span class=\"token punctuation\">(</span><span class=\"token constant\">Comment</span><span class=\"token punctuation\">.</span>arel_table<span class=\"token punctuation\">[</span><span class=\"token symbol\">:created_at</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>desc<span class=\"token punctuation\">)</span></code></pre></div>\n<p>発行されるSQLはこんな感じ。</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token string\">\"posts\"</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> <span class=\"token string\">\"posts\"</span> <span class=\"token keyword\">INNER</span> <span class=\"token keyword\">JOIN</span> <span class=\"token string\">\"comments\"</span> <span class=\"token keyword\">ON</span> <span class=\"token string\">\"comments\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"post_id\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"posts\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"id\"</span>  <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> <span class=\"token string\">\"comments\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"created_at\"</span> <span class=\"token keyword\">DESC</span></code></pre></div>\n<p>こちらの方が個人的には読みやすい。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token constant\">Post</span><span class=\"token punctuation\">.</span>joins<span class=\"token punctuation\">(</span><span class=\"token symbol\">:comments</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>order<span class=\"token punctuation\">(</span><span class=\"token string\">'comments.created_at desc'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>問題もある</h2>\n<h3>テーブル名を変えてしまったとき</h3>\n<p>仮にテーブル名がかわったら後者の場合はエラーになる。</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token string\">\"posts\"</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> <span class=\"token string\">\"posts\"</span> <span class=\"token keyword\">INNER</span> <span class=\"token keyword\">JOIN</span> <span class=\"token string\">\"new_comments\"</span> <span class=\"token keyword\">ON</span> <span class=\"token string\">\"new_comments\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"post_id\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"posts\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"id\"</span>  <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> comments<span class=\"token punctuation\">.</span>created_at <span class=\"token keyword\">DESC</span>\nSQLite3::SQLException: <span class=\"token keyword\">no</span> such <span class=\"token keyword\">column</span>: comments<span class=\"token punctuation\">.</span>created_at: <span class=\"token keyword\">SELECT</span> <span class=\"token string\">\"posts\"</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> <span class=\"token string\">\"posts\"</span> <span class=\"token keyword\">INNER</span> <span class=\"token keyword\">JOIN</span> <span class=\"token string\">\"new_comments\"</span> <span class=\"token keyword\">ON</span> <span class=\"token string\">\"new_comments\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"post_id\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"posts\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"id\"</span>  <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> comments<span class=\"token punctuation\">.</span>created_at D\nESC\nActiveRecord::StatementInvalid: SQLite3::SQLException: <span class=\"token keyword\">no</span> such <span class=\"token keyword\">column</span>: comments<span class=\"token punctuation\">.</span>created_at: <span class=\"token keyword\">SELECT</span> <span class=\"token string\">\"posts\"</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> <span class=\"token string\">\"posts\"</span> <span class=\"token keyword\">INNER</span> <span class=\"token keyword\">JOIN</span> <span class=\"token string\">\"new_comments\"</span> <span class=\"token keyword\">ON</span> <span class=\"token string\">\"new_comments\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"post_id\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"posts\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"id\"</span>\n  <span class=\"token keyword\">ORDER</span> <span class=\"token keyword\">BY</span> comments<span class=\"token punctuation\">.</span>created_at <span class=\"token keyword\">DESC</span></code></pre></div>\n<p>前者はモデルの方でテーブル名を変更すれば動作する。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Comment</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Base</span>\n  <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>table_name  <span class=\"token symbol\">:new_comments</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<h3>scopeでmergeしたいとき</h3>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Comment</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Base</span>\n  scope <span class=\"token symbol\">:recent</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span> where<span class=\"token punctuation\">(</span><span class=\"token string\">'created_at > ?'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10.</span>days<span class=\"token punctuation\">.</span>ago<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">end</span>\n\n<span class=\"token constant\">Post</span><span class=\"token punctuation\">.</span>joins<span class=\"token punctuation\">(</span><span class=\"token symbol\">:comments</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>merge<span class=\"token punctuation\">(</span><span class=\"token constant\">Comment</span><span class=\"token punctuation\">.</span>recent<span class=\"token punctuation\">)</span></code></pre></div>\n<p>これだとCommentのcreated_atが解決できなくてコケる。</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token string\">\"posts\"</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> <span class=\"token string\">\"posts\"</span> <span class=\"token keyword\">INNER</span> <span class=\"token keyword\">JOIN</span> <span class=\"token string\">\"comments\"</span> <span class=\"token keyword\">ON</span> <span class=\"token string\">\"comments\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"post_id\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"posts\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"id\"</span> <span class=\"token keyword\">WHERE</span> <span class=\"token punctuation\">(</span>created_at <span class=\"token operator\">></span> <span class=\"token string\">'2014-08-26 09:16:45.106691'</span><span class=\"token punctuation\">)</span>\nSQLite3::SQLException: ambiguous <span class=\"token keyword\">column</span> name: created_at: <span class=\"token keyword\">SELECT</span> <span class=\"token string\">\"posts\"</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> <span class=\"token string\">\"posts\"</span> <span class=\"token keyword\">INNER</span> <span class=\"token keyword\">JOIN</span> <span class=\"token string\">\"comments\"</span> <span class=\"token keyword\">ON</span> <span class=\"token string\">\"comments\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"post_id\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"posts\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"id\"</span> <span class=\"token keyword\">WHERE</span> <span class=\"token punctuation\">(</span>created_at <span class=\"token operator\">></span> <span class=\"token string\">'2014-08-26 09:16:45.\n106691'</span><span class=\"token punctuation\">)</span>\nActiveRecord::StatementInvalid: SQLite3::SQLException: ambiguous <span class=\"token keyword\">column</span> name: created_at: <span class=\"token keyword\">SELECT</span> <span class=\"token string\">\"posts\"</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> <span class=\"token string\">\"posts\"</span> <span class=\"token keyword\">INNER</span> <span class=\"token keyword\">JOIN</span> <span class=\"token string\">\"comments\"</span> <span class=\"token keyword\">ON</span> <span class=\"token string\">\"comments\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"post_id\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"posts\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"id\"</span> <span class=\"token keyword\">WHERE</span> <span class=\"token punctuation\">(</span>cr\neated_at <span class=\"token operator\">></span> <span class=\"token string\">'2014-08-26 09:16:45.106691'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>正しくはこう。</p>\n<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Comment</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Base</span>\n  scope <span class=\"token symbol\">:recent</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span> where<span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>arel_table<span class=\"token punctuation\">[</span><span class=\"token symbol\">:created_at</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>gt<span class=\"token punctuation\">(</span><span class=\"token number\">10.</span>days<span class=\"token punctuation\">.</span>ago<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">end</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token string\">\"posts\"</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> <span class=\"token string\">\"posts\"</span> <span class=\"token keyword\">INNER</span> <span class=\"token keyword\">JOIN</span> <span class=\"token string\">\"comments\"</span> <span class=\"token keyword\">ON</span> <span class=\"token string\">\"comments\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"post_id\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"posts\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"id\"</span> <span class=\"token keyword\">WHERE</span> <span class=\"token punctuation\">(</span><span class=\"token string\">\"comments\"</span><span class=\"token punctuation\">.</span><span class=\"token string\">\"created_at\"</span> <span class=\"token operator\">></span> <span class=\"token string\">'2014-08-26 09:19:17.406299'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>僕個人の結論</h2>\n<p>Model.arel_tableはできる限り隠したい(読みづらいから)。そしてmergeを使いたいケースではArelを使っておく。その変わりmergeが必要になるまでは無理にArelを使わない。</p>\n<p>さっきのComment#recentの例でいうなら最初は<code class=\"language-text\">where(&#39;created_at &gt; ?&#39;, 10.days.ago)</code>で書いておく。merged使いたい時になったらArelの方で書き直す。</p>\n<p>テーブル名の変更のリスクは気にしない。そもそもあまりテーブル変更しないし…。既にあるDBの上にRailsアプリケーションを構築する場合はDBリファクタリングのことを考えてArel使いまくった方がいいのかもしれない。</p>","frontmatter":{"title":"Arelあれこれ","date":"September 05, 2014","description":null}},"previous":{"fields":{"slug":"posts//2014/04/18/rspec_ctags/"},"frontmatter":{"title":"Vim(TagBar)でRSpecのctagsを扱う"}},"next":{"fields":{"slug":"posts//2014/09/21/rspec_power_assert/"},"frontmatter":{"title":"RSpecでPower Assertをやるには"}}},"pageContext":{"id":"829a39f7-f7e6-5e15-84fd-de16e83389e5","previousPostId":"b142f2eb-5072-5545-a3f8-6e0f12feb1ea","nextPostId":"5bcbeb8c-b027-5a7c-8a40-153e5b3fdb14"}},"staticQueryHashes":["2841359383"]}