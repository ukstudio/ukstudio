<!DOCTYPE html><html><head><meta charset="utf-8" /><!--Always force latest IE rendering engine or request Chrome Frame--><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><!--Use title if it's in the page YAML frontmatter--><title>The Middleman</title><link href="http://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css" /><link href="/stylesheets/normalize.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/highlight.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all.js" type="text/javascript"></script><link href="/feed.xml" rel="alternate" title="atom" type="application/atom+xml" /><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-12755601-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></head><body class="2014 2014_index"><div class="cointainer-fluid"><div class="navbar navbar-default" role="navigation"><div class="container-fluid"><div class="navbar-header"><a class="navbar-brand" href="/">UKSTUDIO</a></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav navbar-right"><li><a href="http://twitter.com/ukstudio">Twitter</a></li><li><a href="http://github.com/ukstudio">GitHub</a></li></ul></div></div></div></div><div class="container"><h1><Archive></Archive>2014</h1><article><h2><a href="/2014/11/27/spotlights-jp/">2014-11-27 spotlights.jp</a></h2><p><a class="embedly-card" href="https://spotlights.jp">みんなで贈るソーシャルギフト・プレゼント ＼SPOTLIGHTS／（スポットライト）</a>
<script async src="//cdn.embedly.com/widgets/platform.js" charset="UTF-8"></script></p>

<div style="text-align: center">
  <iframe width="560" height="315" src="//www.youtube.com/embed/xP14KD2qIR8" frameborder="0" allowfullscreen></iframe>
</div>

<p>今日の10時より<a href="http://spicelife.jp/">株式会社spice life（スパイスライフ）</a>からSPOTLIGHTSがリリースされました!!</p>

<p>ここ2ヶ月弱の追い込みにプログラマとして開発に関わらせて頂いてます(今後も関わっていく予定です)。実は自分のブログで関わってます！って言えるサービスは初めてだと思うので、期間はまだ短いですがちょっと感慨深いものがあります。</p>

<p>結婚式や誕生日のお祝いや日頃の感謝などにご活用ください。</p>
</article><hr /><article><h2><a href="/2014/09/21/rspec_power_assert/">2014-09-21 RSpecでPower Assertをやるには</a></h2><p>RubyKaigi 2014でpower assertの話を聞いてrspecでどうにかならんかちょっと考えてみました。まず結論だけ書くとrspecでpower assertを使いたければ以下の様に書けばOK。</p>
<pre class="highlight ruby"><span class="nb">require</span> <span class="s1">&#39;rspec&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;minitest&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;minitest-power_assert&#39;</span>

<span class="k">module</span> <span class="nn">Minitest</span>
  <span class="k">module</span> <span class="nn">Assertions</span>
    <span class="n">prepend</span>  <span class="no">Minitest</span><span class="o">::</span><span class="no">PowerAssert</span><span class="o">::</span><span class="no">Assertions</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="nf">.configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="nf">.expect_with</span> <span class="ss">:minitest</span>
<span class="k">end</span>

<span class="n">describe</span> <span class="s1">&#39;Test&#39;</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">&#39;test&#39;</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="p">{</span> <span class="mi">1</span><span class="nf">.to_s.class</span> <span class="o">==</span> <span class="mi">1</span><span class="nf">.to_i.class</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
<p>これを</p>
<pre class="highlight shell"><span class="gp">$ </span>rspec --color -rpower_assert power_assert.rb
</pre>
<p>で実行するとこんな感じ。power_assertは事前にrequireした方が情報量がちょっと増える。</p>
<pre class="highlight text">Failures:

  1) Test test
     Failure/Error: assert { 1.to_s.class == 1.to_i.class }
     Minitest::Assertion:

           assert { 1.to_s.class == 1.to_i.class }
                      |    |     |    |    |
                      |    |     |    |    Fixnum
                      |    |     |    1
                      |    |     false
                      |    String
                      &quot;1&quot;
</pre>
<h2 id="letとsubject">letとsubject</h2>

<p>power<em>assertの0.1.3だとdefined</em>methodで定義されたメソッドの値が取れていないらしく、letやsubjectの値が表示されない。現時点でのmasterの0.1.4devだと修正されているとのことなのでちゃんと表示される。</p>
<pre class="highlight ruby"><span class="n">describe</span> <span class="s1">&#39;Test&#39;</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:klass</span><span class="p">)</span> <span class="p">{</span> <span class="mi">1</span><span class="nf">.to_s.class</span> <span class="p">}</span>
  <span class="n">it</span> <span class="s1">&#39;test&#39;</span> <span class="k">do</span>
    <span class="n">assert</span> <span class="p">{</span> <span class="n">klass</span> <span class="o">==</span> <span class="mi">1</span><span class="nf">.to_i.class</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
<p>これを実行すると</p>
<pre class="highlight text">Failures:

  1) Test test
     Failure/Error: assert { klass == 1.to_i.class }
     Minitest::Assertion:

           assert { klass == 1.to_i.class }
                    |     |    |    |
                    |     |    |    Fixnum
                    |     |    1
                    |     false
                    String
</pre>
<p>こんな感じ。subjectも大体おなじ。</p>

<h2 id="expectとマッチャ">expectとマッチャ</h2>

<p>この方法はMinitestのadapterとminitest-power_assertを使うようにしているので無理。</p>

<p>ちなみに <a href="https://gist.github.com/mizoR/3cf068eeae033bd5db5a">rspec で 手軽に power_assert 出力できるようにする</a> の方法でexpectを使ってみると</p>
<pre class="highlight ruby"><span class="nb">require</span> <span class="s1">&#39;rspec/core&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;power_assert&#39;</span>

<span class="k">module</span> <span class="nn">RSpec</span>
  <span class="k">module</span> <span class="nn">PowerAssert</span>
    <span class="k">def </span><span class="nf">power_assert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="o">::</span><span class="no">PowerAssert</span><span class="nf">.start</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">pa</span><span class="o">|</span>
        <span class="k">begin</span>
          <span class="n">pa</span><span class="nf">.yield</span>
        <span class="k">rescue</span> <span class="no">RSpec</span><span class="o">::</span><span class="no">Expectations</span><span class="o">::</span><span class="no">ExpectationNotMetError</span> <span class="o">=&gt;</span> <span class="n">e</span>
          <span class="n">e</span><span class="nf">.message</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">PowerAssert:</span><span class="se">\n</span><span class="si">#{</span><span class="n">pa</span><span class="nf">.message_proc.call</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="k">raise</span> <span class="n">e</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class </span><span class="nc">RSpec</span><span class="o">::</span><span class="no">Core</span><span class="o">::</span><span class="no">ExampleGroup</span>
  <span class="kp">include</span> <span class="no">RSpec</span><span class="o">::</span><span class="no">PowerAssert</span>
<span class="k">end</span>

<span class="n">describe</span> <span class="s1">&#39;Test&#39;</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">&#39;test&#39;</span> <span class="k">do</span>
    <span class="n">power_assert</span> <span class="p">{</span>
      <span class="n">expect</span><span class="p">(</span><span class="mi">1</span><span class="nf">.to_s.class</span><span class="p">)</span><span class="nf">.to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">1</span><span class="nf">.to_i.class</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
<p>これは</p>
<pre class="highlight text">       PowerAssert:
             expect(1.to_s.class).to eq(1.to_i.class)
             |        |    |      |  |    |    |
             |        |    |      |  |    |    Fixnum
             |        |    |      |  |    1
             |        |    |      |  #&lt;RSpec::Matchers::BuiltIn::Eq:0x007f0850c91d78 @expected=Fixnum, @actual=String&gt;
             |        |    |      nil
             |        |    String
             |        &quot;1&quot;
             #&lt;RSpec::Expectations::ExpectationTarget:0x007f0850caa170 @target=String&gt;

</pre>
<p>こうなってしまう。この場合、expectの@targetにStringという結果が入っているのでそれを取り出すようにして、eqの方も@expectedに期待するものがはいってるのでそれを取りだすようにすればいいのかなぁ。</p>

<p>もしくはexpectとeqの中の値さえわかれば良いといえば良いのでいっそ値をださなくてもいいのかも? 例えばこんな感じ。</p>
<pre class="highlight text">       PowerAssert:
             expect(1.to_s.class).to eq(1.to_i.class)
                      |    |              |    |
                      |    |              |    Fixnum
                      |    |              1
                      |    |
                      |    |
                      |    String
                     &quot;1&quot;


</pre>
<p>別の例としてbe_falseyだとこんな感じ。</p>
<pre class="highlight text">     Failure/Error: expect(nil.to_s.to_i).to be_falsey
       expected: falsey value
            got: 0
       PowerAssert:
             expect(nil.to_s.to_i).to be_falsey
             |          |    |     |  |
             |          |    |     |  #&lt;RSpec::Matchers::BuiltIn::BeFalsey:0x007fa84b53bb00 @actual=0&gt;
             |          |    |     nil
             |          |    0
             |          &quot;&quot;
             #&lt;RSpec::Expectations::ExpectationTarget:0x007fa84b3e02b0 @target=0&gt;
</pre>
<p>これに関していうとbe<em>falseyにはfalseが欲しいという情報がない。be</em>falseyを見れば求めてるものはわかるって話かもしれないけど… 更に言うとRSpec3でComposable Matcherが入ったりとか、以前からあるCustom Matcherとかがあったりして、それら全部対応するのは厳しいなーという感じ(そもそも対応できるのかもよくわからない…)</p>

<p>そもそもの話をするとそういったマッチャというか、たくさんあるassertion methodを使い分けしたくないからpower assertをつかうわけで別にマッチャとか使わなくていいのではという気持ちがある。</p>

<p>なのでexpectとかカスタムマッチャとかは(power assertを使う部分では)諦めてassertですませるのがよさそうかなと個人的には思う。</p>
<pre class="highlight ruby"><span class="n">config</span><span class="nf">.expect_with</span> <span class="ss">:minitest</span>
<span class="n">config</span><span class="nf">.expect_with</span> <span class="ss">:rspec</span>
</pre>
<p>spec<em>helper.rbにminitestもrspecも両方使うよう書けばpower</em>assertを使いたいところと、rspecを使いたいところで分けることができるのでどうしてもマッチャを使いたいところは素直にマッチャを書いてpower assertは諦めるしかない。</p>

<p>今あるテスト資産をそのまんまpower assert対応にはできないのが悲しいところではあるけれども、このassertを使う方法でもexpectation部分以外はrspecの機能そのまま使えるのでそこまで悪くはないかなと思う。</p>

<p>まだpower_assert gemの実装を理解できていないので、もしかしたらうまいことやれるかもしれないけどとりあえずここでギブアップ…</p>
</article><hr /><article><h2><a href="/2014/09/05/arel/">2014-09-05 Arelあれこれ</a></h2><h2 id="model.arel_table-を読みづらいと感じる">Model.arel_table を読みづらいと感じる</h2>

<p>例えばこういうコード。</p>
<pre class="highlight ruby"><span class="no">Post</span><span class="nf">.joins</span><span class="p">(</span><span class="ss">:comments</span><span class="p">)</span><span class="nf">.order</span><span class="p">(</span><span class="no">Comment</span><span class="nf">.arel_table</span><span class="o">[</span><span class="ss">:created_at</span><span class="o">]</span><span class="nf">.desc</span><span class="p">)</span>
</pre>
<p>発行されるSQLはこんな感じ。</p>
<pre class="highlight sql"><span class="k">SELECT</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">&quot;posts&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">&quot;comments&quot;</span> <span class="k">ON</span> <span class="nv">&quot;comments&quot;</span><span class="p">.</span><span class="nv">&quot;post_id&quot;</span> <span class="o">=</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="nv">&quot;id&quot;</span>  <span class="k">ORDER</span> <span class="k">BY</span> <span class="nv">&quot;comments&quot;</span><span class="p">.</span><span class="nv">&quot;created_at&quot;</span> <span class="k">DESC</span>
</pre>
<p>こちらの方が個人的には読みやすい。</p>
<pre class="highlight ruby"><span class="no">Post</span><span class="nf">.joins</span><span class="p">(</span><span class="ss">:comments</span><span class="p">)</span><span class="nf">.order</span><span class="p">(</span><span class="s1">&#39;comments.created_at desc&#39;</span><span class="p">)</span>
</pre>
<h2 id="問題もある">問題もある</h2>

<h3 id="テーブル名を変えてしまったとき">テーブル名を変えてしまったとき</h3>

<p>仮にテーブル名がかわったら後者の場合はエラーになる。</p>
<pre class="highlight sql"><span class="k">SELECT</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">&quot;posts&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">&quot;new_comments&quot;</span> <span class="k">ON</span> <span class="nv">&quot;new_comments&quot;</span><span class="p">.</span><span class="nv">&quot;post_id&quot;</span> <span class="o">=</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="nv">&quot;id&quot;</span>  <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">comments</span><span class="p">.</span><span class="n">created_at</span> <span class="k">DESC</span>
<span class="n">SQLite3</span><span class="p">::</span><span class="k">SQLException</span><span class="p">:</span> <span class="k">no</span> <span class="n">such</span> <span class="k">column</span><span class="p">:</span> <span class="n">comments</span><span class="p">.</span><span class="n">created_at</span><span class="p">:</span> <span class="k">SELECT</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">&quot;posts&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">&quot;new_comments&quot;</span> <span class="k">ON</span> <span class="nv">&quot;new_comments&quot;</span><span class="p">.</span><span class="nv">&quot;post_id&quot;</span> <span class="o">=</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="nv">&quot;id&quot;</span>  <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">comments</span><span class="p">.</span><span class="n">created_at</span> <span class="n">D</span>
<span class="n">ESC</span>
<span class="n">ActiveRecord</span><span class="p">::</span><span class="n">StatementInvalid</span><span class="p">:</span> <span class="n">SQLite3</span><span class="p">::</span><span class="k">SQLException</span><span class="p">:</span> <span class="k">no</span> <span class="n">such</span> <span class="k">column</span><span class="p">:</span> <span class="n">comments</span><span class="p">.</span><span class="n">created_at</span><span class="p">:</span> <span class="k">SELECT</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">&quot;posts&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">&quot;new_comments&quot;</span> <span class="k">ON</span> <span class="nv">&quot;new_comments&quot;</span><span class="p">.</span><span class="nv">&quot;post_id&quot;</span> <span class="o">=</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="nv">&quot;id&quot;</span>
  <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">comments</span><span class="p">.</span><span class="n">created_at</span> <span class="k">DESC</span>

</pre>
<p>前者はモデルの方でテーブル名を変更すれば動作する。</p>
<pre class="highlight ruby"><span class="k">class </span><span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="nf">.table_name</span>  <span class="ss">:new_comments</span>
<span class="k">end</span>
</pre>
<h3 id="scopeでmergeしたいとき">scopeでmergeしたいとき</h3>
<pre class="highlight ruby"><span class="k">class </span><span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">scope</span> <span class="ss">:recent</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">&#39;created_at &gt; ?&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="nf">.days.ago</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Post</span><span class="nf">.joins</span><span class="p">(</span><span class="ss">:comments</span><span class="p">)</span><span class="nf">.merge</span><span class="p">(</span><span class="no">Comment</span><span class="nf">.recent</span><span class="p">)</span>
</pre>
<p>これだとCommentのcreated_atが解決できなくてコケる。</p>
<pre class="highlight sql"><span class="k">SELECT</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">&quot;posts&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">&quot;comments&quot;</span> <span class="k">ON</span> <span class="nv">&quot;comments&quot;</span><span class="p">.</span><span class="nv">&quot;post_id&quot;</span> <span class="o">=</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="nv">&quot;id&quot;</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">created_at</span> <span class="o">&gt;</span> <span class="s1">&#39;2014-08-26 09:16:45.106691&#39;</span><span class="p">)</span>
<span class="n">SQLite3</span><span class="p">::</span><span class="k">SQLException</span><span class="p">:</span> <span class="n">ambiguous</span> <span class="k">column</span> <span class="n">name</span><span class="p">:</span> <span class="n">created_at</span><span class="p">:</span> <span class="k">SELECT</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">&quot;posts&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">&quot;comments&quot;</span> <span class="k">ON</span> <span class="nv">&quot;comments&quot;</span><span class="p">.</span><span class="nv">&quot;post_id&quot;</span> <span class="o">=</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="nv">&quot;id&quot;</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">created_at</span> <span class="o">&gt;</span> <span class="s1">&#39;2014-08-26 09:16:45.
106691&#39;</span><span class="p">)</span>
<span class="n">ActiveRecord</span><span class="p">::</span><span class="n">StatementInvalid</span><span class="p">:</span> <span class="n">SQLite3</span><span class="p">::</span><span class="k">SQLException</span><span class="p">:</span> <span class="n">ambiguous</span> <span class="k">column</span> <span class="n">name</span><span class="p">:</span> <span class="n">created_at</span><span class="p">:</span> <span class="k">SELECT</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">&quot;posts&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">&quot;comments&quot;</span> <span class="k">ON</span> <span class="nv">&quot;comments&quot;</span><span class="p">.</span><span class="nv">&quot;post_id&quot;</span> <span class="o">=</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="nv">&quot;id&quot;</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">cr</span>
<span class="n">eated_at</span> <span class="o">&gt;</span> <span class="s1">&#39;2014-08-26 09:16:45.106691&#39;</span><span class="p">)</span>
</pre>
<p>正しくはこう。</p>
<pre class="highlight ruby"><span class="k">class </span><span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">scope</span> <span class="ss">:recent</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="nb">self</span><span class="nf">.arel_table</span><span class="o">[</span><span class="ss">:created_at</span><span class="o">]</span><span class="nf">.gt</span><span class="p">(</span><span class="mi">10</span><span class="nf">.days.ago</span><span class="p">))</span> <span class="p">}</span>
<span class="k">end</span>
</pre><pre class="highlight sql"><span class="k">SELECT</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">&quot;posts&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">&quot;comments&quot;</span> <span class="k">ON</span> <span class="nv">&quot;comments&quot;</span><span class="p">.</span><span class="nv">&quot;post_id&quot;</span> <span class="o">=</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="nv">&quot;id&quot;</span> <span class="k">WHERE</span> <span class="p">(</span><span class="nv">&quot;comments&quot;</span><span class="p">.</span><span class="nv">&quot;created_at&quot;</span> <span class="o">&gt;</span> <span class="s1">&#39;2014-08-26 09:19:17.406299&#39;</span><span class="p">)</span>
</pre>
<h2 id="僕個人の結論">僕個人の結論</h2>

<p>Model.arel_tableはできる限り隠したい(読みづらいから)。そしてmergeを使いたいケースではArelを使っておく。その変わりmergeが必要になるまでは無理にArelを使わない。</p>

<p>さっきのComment#recentの例でいうなら最初は<code>where(&#39;created_at &gt; ?&#39;, 10.days.ago)</code>で書いておく。merged使いたい時になったらArelの方で書き直す。</p>

<p>テーブル名の変更のリスクは気にしない。そもそもあまりテーブル変更しないし…。既にあるDBの上にRailsアプリケーションを構築する場合はDBリファクタリングのことを考えてArel使いまくった方がいいのかもしれない。</p>
</article><hr /><article><h2><a href="/2014/04/18/rspec_ctags/">2014-04-18 Vim(TagBar)でRSpecのctagsを扱う</a></h2><p><img alt="rspec ctags" src="/images/2014-04-18-vim-rspec-ctags.png" /></p>

<p>unite-outlineとかを使う人には不要なのかもしれないけど、あいにくuniteユーザではないのでctagsでなんとかできないか調べてみた。</p>

<p>まず、Funtooで入るctagsではrspecのタグは生成できないのでforkされたctagsを使う必要がある。</p>

<p><a href="https://github.com/fishman/ctags">fishman/ctags</a></p>

<p>インストール場所はお好みで。個人的には手で入れる系のものは$HOME/localにインストールするのが好きなのでそこにインストールした。あとはTagBarの方でこのctagsを使うよう設定する。</p>
<pre class="highlight viml"><span class="k">let</span> <span class="nv">g:tagbar_ctags_bin</span><span class="p">=</span><span class="s2">&quot;/home/ukstudio/local/bin/ctags&quot;</span>
<span class="k">let</span> <span class="nv">g:tagbar_type_ruby</span> <span class="p">=</span> <span class="p">{</span>
<span class="se">    \</span> <span class="s1">&#39;kinds&#39;</span> <span class="p">:</span> <span class="p">[</span>
<span class="se">        \</span> <span class="s1">&#39;m:modules&#39;</span><span class="p">,</span>
<span class="se">        \</span> <span class="s1">&#39;c:classes&#39;</span><span class="p">,</span>
<span class="se">        \</span> <span class="s1">&#39;d:describes&#39;</span><span class="p">,</span>
<span class="se">        \</span> <span class="s1">&#39;C:contexts&#39;</span><span class="p">,</span>
<span class="se">        \</span> <span class="s1">&#39;f:methods&#39;</span><span class="p">,</span>
<span class="se">        \</span> <span class="s1">&#39;F:singleton methods&#39;</span>
<span class="se">    \</span> <span class="p">]</span>
<span class="se">\</span> <span class="p">}</span>
</pre>
<p>これで上の画像のような感じでTagBarに表示されるようになるはず。</p>
</article><hr /><article><h2><a href="/2014/03/27/erutaso_ebuild/">2014-03-27 lsと間違えてerutasoを打ってしまうGentoo/Funtooユーザーのみなさまへ</a></h2><p><a href="https://github.com/ukstudio/ukstudio-overlay/tree/master/app-shells/erutaso/">ebuild</a>を作ってみましたのでご活用ください。初めてのebuildなので不具合・不都合あればpull-reqを。ukstudioというoverlayを作りましたのでそこからインストールできるはずです。</p>

<p><a href="https://github.com/ukstudio/ukstudio-overlay">https://github.com/ukstudio/ukstudio-overlay</a></p>
<pre class="highlight shell">curl https://raw.github.com/ukstudio/ukstudio-overlay/master/profiles/layman.xml &gt; /etc/layman/overlays/ukstudio-overlay.xml
layman -f -a ukstudio

emerge erutaso
which erutaso <span class="c">#=&gt; /usr/bin/erutaso</span>

erutaso
</pre>
<h2 id="see-also">See also</h2>

<p><a href="https://twitter.com/sgymtic/status/448832543039574016">https://twitter.com/sgymtic/status/448832543039574016</a></p>
</article><hr /><article><h2><a href="/2014/03/18/bitlbee_hipchat/">2014-03-18 BitlBeeでHipChatに接続する</a></h2><p>HipChatのLinuxクライアントは残念ながら日本語入力ができないのでかわりにIRCを使ってみる。
HipChatはJabberが使えるのでBitlBeeを使ってJabber経由でIRCと繋ぐことにする。BitlBee自体の設定はなにもいらないので各環境にあわせて適当に入れて起動する。</p>
<pre class="highlight text">sudo emerge bitlbee
sudo /etc/init.d/bitlbee start
</pre>
<p>次にIRCクライアントでBitlBeeに接続する。BitlBeeはlocalhostに6667ポートで立ち上がっているので(コンフィグで修正していなければ)、そこに接続する。文字コードはUTF-8でOK。
接続できたらbitlbeeの部屋でコマンドを入力し、アカウントを追加する。HipChatのJabberのアカウントは「Account Setting &gt; XMPP/Jabber info」にある。</p>
<pre class="highlight text">account add jabber username@chat.hipchat.com &#39;password&#39;
</pre>
<p>次に各ユーザがニックネームで表示されるように設定する。これをやらないと数字の羅列で誰が誰だかわからない状態になってしまう。</p>
<pre class="highlight text">account hipchat set nick_source full_name
</pre>
<p>次にアカウントを有効化する。この時点で認証などもしているので失敗したらアカウント情報を見直すこと。</p>
<pre class="highlight text">account hipchat on
</pre>
<p>有効化できたらすでに部屋に参加できるが数字の羅列が頭についているので使いにくい。別の名前を割り当てることができるので適当に自分が使いやすい名前をつける。</p>
<pre class="highlight text">chat add hipchat room_jaber_name@conf.hipchat.com #channelname
</pre>
<p>ニックの設定次第だとHipChatから怒られるのでその場合HipCHatで使っている名前を設定する。</p>
<pre class="highlight text">channel #channelname set nick &#39;room nickname&#39;
</pre>
<p>無事、部屋にjoinしてログが流れてきたら終了。</p>
<pre class="highlight text">/join #channelname
</pre></article><hr /><article><h2><a href="/2014/03/13/bittorrentsync_qnap_funtoo/">2014-03-13 BitTorrent SyncでQNAPとFuntooで同期する</a></h2><p>QNAPの一部のディレクトリ(主に電子書籍)とローカルのマシンで同期を取りたかったのでBitTorrent Syncで同期を取ってみる。NFSでもいいんだけど、電子書籍ぐらいならローカルにおけるぐらいのストレージ容量はあるので。</p>

<h2 id="qnapにbittorrent-syncを入れる">QNAPにBitTorrent Syncを入れる</h2>

<p>基本的には<a href="http://www.qnap.com/useng/index.php?sn=9137">QNAPのドキュメント</a>を参照すれば問題ないと思う。簡単に説明しておくとQTSにBitTorrent Syncを追加し、BitTorrent SyncのWebUIを起動する。WebUIのアクセスユーザは途中で&quot;Please modify the Login ID / Password&quot;とか言われる画面でLogin IDとPasswordを入力し、Apply Changesをすればそのユーザで接続できる。</p>

<p>次にBitTorrent SyncのWebUIが起動したらAdd Folderから該当のディレクトリを選択する。Secret KeyはここでGenerateしておく。(後でローカルの方の設定で使用する)。QNAP側はこれで終わり。</p>

<h2 id="funtooにbittorrent-syncを入れる">FuntooにBitTorrent Syncを入れる</h2>

<p>FuntooはportageにBitTorrent Syncのebuildがあるのでそれを使う。</p>
<pre class="highlight text">sudo emerge bittorrent sync
</pre>
<p>起動は<code>/etc/init.d/btsync start</code>だが、コンフィグの修正が必要。init.dで起動するとログがでないからわからないが、<code>/opt/btsync/btsync</code>で起動するとstorage_pathが存在しないと怒られるのがわかる。コンフィグは<code>/etc/btsync/config</code>がそう。</p>
<pre class="highlight text">// &quot;storage_path&quot; : &quot;/home/user/.sync&quot;,
&quot;storage_path&quot; : &quot;/home/ukstudio/.sync&quot;,
</pre>
<p>ディレクトリはお好みで。</p>

<p><code>/etc/init.d/btsync start</code>で無事btsyncが起動したら、<a href="http://localhost:8888/gui%E3%81%A7WebUI%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%A7%E3%81%8D%E3%82%8B%E3%80%82ID%E3%81%A8%E3%83%91%E3%82%B9%E3%81%AF&#x27;admin&#x27;%E3%81%A8&#x27;password&#x27;%E3%80%82">http://localhost:8888/guiでWebUIにアクセスできる。IDとパスは&#39;admin&#39;と&#39;password&#39;。</a></p>

<p>WebUIにアクセスできたら、Add FolderでQNAPと同期させたいディレクトリを指定する。Secret Keyはここでは生成させず先程のQNAPのsecret keyをコピペする。保存し、WebUIのトップ画面で&quot;connected devices and status&quot;でダウンロード速度が表示されたら無事同期がはじまっている。</p>
</article><hr /><article><h2><a href="/2014/03/13/openvpn_qnap_funtoo/">2014-03-13 FuntooからQNAPにOpenVPNでつなぐ</a></h2><p>まずはFuntooにOpenVPNを入れる。</p>
<pre class="highlight text">sudo emerge openvpn
</pre>
<p>次にQNAPからOpenVPNの設定ファイルをダウンロードする。場所は「コントロール・パネル -&gt; アプリケーション -&gt; VPNサービス -&gt; 設定ファイルのダウンロード」にある。(QTS 4.0.3)</p>

<p>zipが落ちてくるのでunzipするとca.crtとopenvpn.ovpnが展開されるので/etc/openvpnにmvする。他にOpenVPNで接続するところはないのでそのまま放りこむ。openvpn.opvnのままだと/etc/init.d/openvpn start時に怒られるのでopenvpn.confにリネーム。</p>
<pre class="highlight text">/etc/init.d/openvpn start
</pre>
<p>で起動する。ユーザとパスを聞かれるのでadminで認証する。他のユーザーで認証したい場合はVPNサービスの設定からユーザを追加する。ローカルIPでQNAPに繋れば無事終了。</p>
</article><hr /><article><h2><a href="/2014/03/05/kensington_slimblade/">2014-03-05 Kensingtonのslimbladeを導入</a></h2><p>ちょっと新しいマウスを捜してたのでこの機会にトラックボールに移行してみた。購入したのはKensingtonの<a href="http://www.amazon.co.jp/gp/product/B0024AFD42?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B0024AFD42&amp;linkCode=shr&amp;tag=ukstudio0c-22">SlimBlade</a>。</p><p>昔はLinuxで使うと上の2つのボタンが使えなかったみたいだけど、今はパッチがあたったようで問題なく使える。なぜか右奥がバックボタンなのに左奥がミドルボタンだけど。この辺のリマップはxorg.confあたりでいいのかな。あまり困りはしないのでとりあえずは特に設定を変えずに使ってみることにする。</p></article><hr /></div></body></html>