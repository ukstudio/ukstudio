<!DOCTYPE html><html><head><meta charset="utf-8" /><!--Always force latest IE rendering engine or request Chrome Frame--><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><!--Use title if it's in the page YAML frontmatter--><title>ukstudio.jp</title><link href="http://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css" /><link href="/stylesheets/normalize.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/highlight.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all.js" type="text/javascript"></script><link href="/feed.xml" rel="alternate" title="atom" type="application/atom+xml" /><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-12755601-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></head><body class="page page_3 page_3_index"><div class="cointainer-fluid"><div class="navbar navbar-default" role="navigation"><div class="container-fluid"><div class="navbar-header"><a class="navbar-brand" href="/">UKSTUDIO</a></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav navbar-right"><li><a href="http://twitter.com/ukstudio">Twitter</a></li><li><a href="http://github.com/ukstudio">GitHub</a></li></ul></div></div></div></div><div class="container"><article><h1><a href="/2014/03/13/openvpn_qnap_funtoo/">2014-03-13 FuntooからQNAPにOpenVPNでつなぐ</a></h1><hr /><div class="article-body"><p>まずはFuntooにOpenVPNを入れる。</p>
<pre class="highlight text">sudo emerge openvpn
</pre>
<p>次にQNAPからOpenVPNの設定ファイルをダウンロードする。場所は「コントロール・パネル -&gt; アプリケーション -&gt; VPNサービス -&gt; 設定ファイルのダウンロード」にある。(QTS 4.0.3)</p>

<p>zipが落ちてくるのでunzipするとca.crtとopenvpn.ovpnが展開されるので/etc/openvpnにmvする。他にOpenVPNで接続するところはないのでそのまま放りこむ。openvpn.opvnのままだと/etc/init.d/openvpn start時に怒られるのでopenvpn.confにリネーム。</p>
<pre class="highlight text">/etc/init.d/openvpn start
</pre>
<p>で起動する。ユーザとパスを聞かれるのでadminで認証する。他のユーザーで認証したい場合はVPNサービスの設定からユーザを追加する。ローカルIPでQNAPに繋れば無事終了。</p>
</div></article><article><h1><a href="/2014/03/05/kensington_slimblade/">2014-03-05 Kensingtonのslimbladeを導入</a></h1><hr /><div class="article-body"><p>ちょっと新しいマウスを捜してたのでこの機会にトラックボールに移行してみた。購入したのはKensingtonの<a href="http://www.amazon.co.jp/gp/product/B0024AFD42?ie=UTF8&amp;camp=1207&amp;creative=8411&amp;creativeASIN=B0024AFD42&amp;linkCode=shr&amp;tag=ukstudio0c-22">SlimBlade</a>。</p><p>昔はLinuxで使うと上の2つのボタンが使えなかったみたいだけど、今はパッチがあたったようで問題なく使える。なぜか右奥がバックボタンなのに左奥がミドルボタンだけど。この辺のリマップはxorg.confあたりでいいのかな。あまり困りはしないのでとりあえずは特に設定を変えずに使ってみることにする。</p></div></article><article><h1><a href="/2013/12/27/funtoo/">2013-12-27 GentooからFuntooに移行しました</a></h1><hr /><div class="article-body"><p>GentooからFuntooに移行した。<a href="http://esminc.doorkeeper.jp/events/3547">Funtoo Linux インストール講習会</a>から大分日が立ってしまった。</p><p>インストール自体は<a href="http://www.funtoo.org/Funtoo_Linux_Installation">Funtoo Linux Installation</a>をそのまま実行。boot-updateのビルドだけ失敗したが、texinfo-5.1以上をmaskしたら解決。</p><p>ネット関係はNetworkManagerが妙に不安定だったのでwicdを使うことにした。wicd-cursesがいい感じ。今のところ接続も安定している。</p><p>X環境まわりは例のごとくXmonadで。GNOMEも一度入れたけど、結局使わないのでアンインストール。mix-inのGNOMEも余計なUSEフラグをつけて邪魔だったので使わないことにした。</p><p>GNOMEを削除したのでGDMではなくSlimeを使うことにした。GDMとかstartxがxinitrcを読むのかxprofileを読むのかとかいっつも忘れる…</p><p>その他GitやらRubyやら入れてひととおり終了。カーネルをバイナリで入れてるので起動が遅いけどカーネルのコンフィグでハマるのもダルいしとりあえずこのままで行く予定。</p></div></article><article><h1><a href="/2013/10/18/middleman/">2013-10-18 ブログをWordPressからmiddlemanに移行しました</a></h1><hr /><div class="article-body"><p>今まで当ブログはWordPressでブログを書いていたけれど、今回<a href="http://middlemanapp.com/">middleman</a>を使うことにした。特になにかが気に入ってmiddlemanを選んだわけでもないのだけど、しばらくはこれで運用してみようと思う。</p><p>運用はGithub Pageで行なうことにした。これで今まで中途半端に保持していたVPSを解約することができる。最近はIRCを全然使ってないからいいけど、なんかの機会に使うようになったらtiarraとかをどう運用するか考えなくちゃいけないなぁ。</p><p>デザインやその他足りない機能は追々増やしていこうとおもいます。とりあえずRSSだけは用意した。</p></div></article><article><h1><a href="/2012/09/11/validates_presence_of/">2012-09-11 validates :foo_id, :presence => trueを追う</a></h1><hr /><div class="article-body">チームメンバーから「validates_presence_of :user_idはそのuser_idが存在するか確かめてくれる」という情報を得て、そんな隠れ仕様あんの?とおもってちょっと調べてみた。

結論だけまず言うと
<pre>
validates :user_id, :presence => true
validates_presence_of :user_id
</pre>
ではなく、
<pre>
validates :user, :presence => true
validates_presence_of :user, :presence => true
</pre>
の用に関連名を指定するとそれっぽい動作をしなくもない。

とりあえずコードを追うとpresence系のバリデーション自体はActiveModel::Validations::PresenceValidatorで定義されている。

<pre>module ActiveModel
  # == Active Model Presence Validator
  module Validations
    class PresenceValidator < EachValidator
      def validate(record)
        record.errors.add_on_blank(attributes, options)
</pre>

次にadd_on_blankを見てみる。

<pre># File activemodel/lib/active_model/errors.rb, line 251
def add_on_blank(attributes, options = {})
  [attributes].flatten.each do |attribute|
    value = @base.send(:read_attribute_for_validation, attribute)
    add(attribute, :blank, options) if value.blank?
  end
end
</pre>

add_on_blankメソッドはattributesの内容を走査してblankだったらerrorsに追加してるんだろうなーというのが読み取れる。じゃあ実際に値を取ってきてるであろう:read_attribute_for_validationは何なのだろう。api.rubyonrails.orgで検索してもヒットしない。仕方ないからgitリポジトリをgrepして探す。そうすると以下の様なコードがみつかる。

<pre># activemodel/lib/active_model/validations.rb line 327
alias :read_attribute_for_validation :send
</pre>

つまりただのsend。なので

<pre>validates :user_id, :presence => true</pre>

というコードは

<pre>instance.send(:send, :user_id)</pre>

となり、結局は普通に指定した属性の値を見るに過ぎない。


で、最初の話に戻るが

<pre>
validates :user_id, :presence => true
</pre>
は普通にuser_idの値がblank?かどうかだけを見るので実際にそのuser_idでUserが存在するかチェックはしない。

<pre>
validates :user, :presence => true
</pre>

はどうかというと、instance.userがnilの状態でinstance.userを呼び出すとinstance.user_idでUserを取りにいく。そこでUserが存在しなければ[]が返ってくるのでblank?がtrueとなりこのバリデーションは失敗する。

<pre>
instance = Model.new
instance.user_id = 111111111
instance.valid? #=> false
  User Load (3.4ms)  SELECT "users".* FROM "users" WHERE ""."id" = 111111111 LIMIT 1
</pre>

なので、このケースに限って言えばそのIDのレコードが存在するか確認する動作をしている。とは言え、あくまでisntance.userの値を見るだけなので

<pre>
instance = Model.new
instance.user = User.new
instance.valid? #=> true
</pre>

この様に直接値を入れてしまえばDBにselect文はなげない。

なので、そういう動作をすることもあるだけで厳密にはそのIDのレコードが存在を確かめているわけではない。
</div></article><div class="pager"><ul><li class="previous"><a href="/page/2/">Prev</a></li><li class="next"><a href="/page/4/">Next</a></li></ul></div></div></body></html>