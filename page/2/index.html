<!DOCTYPE html><html><head><meta charset="utf-8" /><!--Always force latest IE rendering engine or request Chrome Frame--><meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" /><!--Use title if it's in the page YAML frontmatter--><title>ukstudio.jp</title><link href="http://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet" type="text/css" /><link href="/stylesheets/normalize.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/all.css" media="screen" rel="stylesheet" type="text/css" />
<link href="/stylesheets/highlight.css" media="screen" rel="stylesheet" type="text/css" /><script src="/javascripts/all.js" type="text/javascript"></script><link href="/feed.xml" rel="alternate" title="atom" type="application/atom+xml" /><script type="text/javascript">var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-12755601-1']);
_gaq.push(['_trackPageview']);

(function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script></head><body class="page page_2 page_2_index"><div class="cointainer-fluid"><div class="navbar navbar-default" role="navigation"><div class="container-fluid"><div class="navbar-header"><a class="navbar-brand" href="/">UKSTUDIO</a></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav navbar-right"><li><a href="http://twitter.com/ukstudio">Twitter</a></li><li><a href="http://github.com/ukstudio">GitHub</a></li></ul></div></div></div></div><div class="container"><article><h1><a href="/2014/09/05/arel/">2014-09-05 Arelあれこれ</a></h1><hr /><div class="article-body"><h2 id="model.arel_table-を読みづらいと感じる">Model.arel_table を読みづらいと感じる</h2>

<p>例えばこういうコード。</p>
<pre class="highlight ruby"><span class="no">Post</span><span class="nf">.joins</span><span class="p">(</span><span class="ss">:comments</span><span class="p">)</span><span class="nf">.order</span><span class="p">(</span><span class="no">Comment</span><span class="nf">.arel_table</span><span class="o">[</span><span class="ss">:created_at</span><span class="o">]</span><span class="nf">.desc</span><span class="p">)</span>
</pre>
<p>発行されるSQLはこんな感じ。</p>
<pre class="highlight sql"><span class="k">SELECT</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">&quot;posts&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">&quot;comments&quot;</span> <span class="k">ON</span> <span class="nv">&quot;comments&quot;</span><span class="p">.</span><span class="nv">&quot;post_id&quot;</span> <span class="o">=</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="nv">&quot;id&quot;</span>  <span class="k">ORDER</span> <span class="k">BY</span> <span class="nv">&quot;comments&quot;</span><span class="p">.</span><span class="nv">&quot;created_at&quot;</span> <span class="k">DESC</span>
</pre>
<p>こちらの方が個人的には読みやすい。</p>
<pre class="highlight ruby"><span class="no">Post</span><span class="nf">.joins</span><span class="p">(</span><span class="ss">:comments</span><span class="p">)</span><span class="nf">.order</span><span class="p">(</span><span class="s1">&#39;comments.created_at desc&#39;</span><span class="p">)</span>
</pre>
<h2 id="問題もある">問題もある</h2>

<h3 id="テーブル名を変えてしまったとき">テーブル名を変えてしまったとき</h3>

<p>仮にテーブル名がかわったら後者の場合はエラーになる。</p>
<pre class="highlight sql"><span class="k">SELECT</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">&quot;posts&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">&quot;new_comments&quot;</span> <span class="k">ON</span> <span class="nv">&quot;new_comments&quot;</span><span class="p">.</span><span class="nv">&quot;post_id&quot;</span> <span class="o">=</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="nv">&quot;id&quot;</span>  <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">comments</span><span class="p">.</span><span class="n">created_at</span> <span class="k">DESC</span>
<span class="n">SQLite3</span><span class="p">::</span><span class="k">SQLException</span><span class="p">:</span> <span class="k">no</span> <span class="n">such</span> <span class="k">column</span><span class="p">:</span> <span class="n">comments</span><span class="p">.</span><span class="n">created_at</span><span class="p">:</span> <span class="k">SELECT</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">&quot;posts&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">&quot;new_comments&quot;</span> <span class="k">ON</span> <span class="nv">&quot;new_comments&quot;</span><span class="p">.</span><span class="nv">&quot;post_id&quot;</span> <span class="o">=</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="nv">&quot;id&quot;</span>  <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">comments</span><span class="p">.</span><span class="n">created_at</span> <span class="n">D</span>
<span class="n">ESC</span>
<span class="n">ActiveRecord</span><span class="p">::</span><span class="n">StatementInvalid</span><span class="p">:</span> <span class="n">SQLite3</span><span class="p">::</span><span class="k">SQLException</span><span class="p">:</span> <span class="k">no</span> <span class="n">such</span> <span class="k">column</span><span class="p">:</span> <span class="n">comments</span><span class="p">.</span><span class="n">created_at</span><span class="p">:</span> <span class="k">SELECT</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">&quot;posts&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">&quot;new_comments&quot;</span> <span class="k">ON</span> <span class="nv">&quot;new_comments&quot;</span><span class="p">.</span><span class="nv">&quot;post_id&quot;</span> <span class="o">=</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="nv">&quot;id&quot;</span>
  <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">comments</span><span class="p">.</span><span class="n">created_at</span> <span class="k">DESC</span>

</pre>
<p>前者はモデルの方でテーブル名を変更すれば動作する。</p>
<pre class="highlight ruby"><span class="k">class </span><span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="nf">.table_name</span>  <span class="ss">:new_comments</span>
<span class="k">end</span>
</pre>
<h3 id="scopeでmergeしたいとき">scopeでmergeしたいとき</h3>
<pre class="highlight ruby"><span class="k">class </span><span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">scope</span> <span class="ss">:recent</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s1">&#39;created_at &gt; ?&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="nf">.days.ago</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Post</span><span class="nf">.joins</span><span class="p">(</span><span class="ss">:comments</span><span class="p">)</span><span class="nf">.merge</span><span class="p">(</span><span class="no">Comment</span><span class="nf">.recent</span><span class="p">)</span>
</pre>
<p>これだとCommentのcreated_atが解決できなくてコケる。</p>
<pre class="highlight sql"><span class="k">SELECT</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">&quot;posts&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">&quot;comments&quot;</span> <span class="k">ON</span> <span class="nv">&quot;comments&quot;</span><span class="p">.</span><span class="nv">&quot;post_id&quot;</span> <span class="o">=</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="nv">&quot;id&quot;</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">created_at</span> <span class="o">&gt;</span> <span class="s1">&#39;2014-08-26 09:16:45.106691&#39;</span><span class="p">)</span>
<span class="n">SQLite3</span><span class="p">::</span><span class="k">SQLException</span><span class="p">:</span> <span class="n">ambiguous</span> <span class="k">column</span> <span class="n">name</span><span class="p">:</span> <span class="n">created_at</span><span class="p">:</span> <span class="k">SELECT</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">&quot;posts&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">&quot;comments&quot;</span> <span class="k">ON</span> <span class="nv">&quot;comments&quot;</span><span class="p">.</span><span class="nv">&quot;post_id&quot;</span> <span class="o">=</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="nv">&quot;id&quot;</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">created_at</span> <span class="o">&gt;</span> <span class="s1">&#39;2014-08-26 09:16:45.
106691&#39;</span><span class="p">)</span>
<span class="n">ActiveRecord</span><span class="p">::</span><span class="n">StatementInvalid</span><span class="p">:</span> <span class="n">SQLite3</span><span class="p">::</span><span class="k">SQLException</span><span class="p">:</span> <span class="n">ambiguous</span> <span class="k">column</span> <span class="n">name</span><span class="p">:</span> <span class="n">created_at</span><span class="p">:</span> <span class="k">SELECT</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">&quot;posts&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">&quot;comments&quot;</span> <span class="k">ON</span> <span class="nv">&quot;comments&quot;</span><span class="p">.</span><span class="nv">&quot;post_id&quot;</span> <span class="o">=</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="nv">&quot;id&quot;</span> <span class="k">WHERE</span> <span class="p">(</span><span class="n">cr</span>
<span class="n">eated_at</span> <span class="o">&gt;</span> <span class="s1">&#39;2014-08-26 09:16:45.106691&#39;</span><span class="p">)</span>
</pre>
<p>正しくはこう。</p>
<pre class="highlight ruby"><span class="k">class </span><span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">scope</span> <span class="ss">:recent</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="nb">self</span><span class="nf">.arel_table</span><span class="o">[</span><span class="ss">:created_at</span><span class="o">]</span><span class="nf">.gt</span><span class="p">(</span><span class="mi">10</span><span class="nf">.days.ago</span><span class="p">))</span> <span class="p">}</span>
<span class="k">end</span>
</pre><pre class="highlight sql"><span class="k">SELECT</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">&quot;posts&quot;</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="nv">&quot;comments&quot;</span> <span class="k">ON</span> <span class="nv">&quot;comments&quot;</span><span class="p">.</span><span class="nv">&quot;post_id&quot;</span> <span class="o">=</span> <span class="nv">&quot;posts&quot;</span><span class="p">.</span><span class="nv">&quot;id&quot;</span> <span class="k">WHERE</span> <span class="p">(</span><span class="nv">&quot;comments&quot;</span><span class="p">.</span><span class="nv">&quot;created_at&quot;</span> <span class="o">&gt;</span> <span class="s1">&#39;2014-08-26 09:19:17.406299&#39;</span><span class="p">)</span>
</pre>
<h2 id="僕個人の結論">僕個人の結論</h2>

<p>Model.arel_tableはできる限り隠したい(読みづらいから)。そしてmergeを使いたいケースではArelを使っておく。その変わりmergeが必要になるまでは無理にArelを使わない。</p>

<p>さっきのComment#recentの例でいうなら最初は<code>where(&#39;created_at &gt; ?&#39;, 10.days.ago)</code>で書いておく。merged使いたい時になったらArelの方で書き直す。</p>

<p>テーブル名の変更のリスクは気にしない。そもそもあまりテーブル変更しないし…。既にあるDBの上にRailsアプリケーションを構築する場合はDBリファクタリングのことを考えてArel使いまくった方がいいのかもしれない。</p>
</div></article><article><h1><a href="/2014/04/18/rspec_ctags/">2014-04-18 Vim(TagBar)でRSpecのctagsを扱う</a></h1><hr /><div class="article-body"><p><img alt="rspec ctags" src="/images/2014-04-18-vim-rspec-ctags.png" /></p>

<p>unite-outlineとかを使う人には不要なのかもしれないけど、あいにくuniteユーザではないのでctagsでなんとかできないか調べてみた。</p>

<p>まず、Funtooで入るctagsではrspecのタグは生成できないのでforkされたctagsを使う必要がある。</p>

<p><a href="https://github.com/fishman/ctags">fishman/ctags</a></p>

<p>インストール場所はお好みで。個人的には手で入れる系のものは$HOME/localにインストールするのが好きなのでそこにインストールした。あとはTagBarの方でこのctagsを使うよう設定する。</p>
<pre class="highlight viml"><span class="k">let</span> <span class="nv">g:tagbar_ctags_bin</span><span class="p">=</span><span class="s2">&quot;/home/ukstudio/local/bin/ctags&quot;</span>
<span class="k">let</span> <span class="nv">g:tagbar_type_ruby</span> <span class="p">=</span> <span class="p">{</span>
<span class="se">    \</span> <span class="s1">&#39;kinds&#39;</span> <span class="p">:</span> <span class="p">[</span>
<span class="se">        \</span> <span class="s1">&#39;m:modules&#39;</span><span class="p">,</span>
<span class="se">        \</span> <span class="s1">&#39;c:classes&#39;</span><span class="p">,</span>
<span class="se">        \</span> <span class="s1">&#39;d:describes&#39;</span><span class="p">,</span>
<span class="se">        \</span> <span class="s1">&#39;C:contexts&#39;</span><span class="p">,</span>
<span class="se">        \</span> <span class="s1">&#39;f:methods&#39;</span><span class="p">,</span>
<span class="se">        \</span> <span class="s1">&#39;F:singleton methods&#39;</span>
<span class="se">    \</span> <span class="p">]</span>
<span class="se">\</span> <span class="p">}</span>
</pre>
<p>これで上の画像のような感じでTagBarに表示されるようになるはず。</p>
</div></article><article><h1><a href="/2014/03/27/erutaso_ebuild/">2014-03-27 lsと間違えてerutasoを打ってしまうGentoo/Funtooユーザーのみなさまへ</a></h1><hr /><div class="article-body"><p><a href="https://github.com/ukstudio/ukstudio-overlay/tree/master/app-shells/erutaso/">ebuild</a>を作ってみましたのでご活用ください。初めてのebuildなので不具合・不都合あればpull-reqを。ukstudioというoverlayを作りましたのでそこからインストールできるはずです。</p>

<p><a href="https://github.com/ukstudio/ukstudio-overlay">https://github.com/ukstudio/ukstudio-overlay</a></p>
<pre class="highlight shell">curl https://raw.github.com/ukstudio/ukstudio-overlay/master/profiles/layman.xml &gt; /etc/layman/overlays/ukstudio-overlay.xml
layman -f -a ukstudio

emerge erutaso
which erutaso <span class="c">#=&gt; /usr/bin/erutaso</span>

erutaso
</pre>
<h2 id="see-also">See also</h2>

<p><a href="https://twitter.com/sgymtic/status/448832543039574016">https://twitter.com/sgymtic/status/448832543039574016</a></p>
</div></article><article><h1><a href="/2014/03/18/bitlbee_hipchat/">2014-03-18 BitlBeeでHipChatに接続する</a></h1><hr /><div class="article-body"><p>HipChatのLinuxクライアントは残念ながら日本語入力ができないのでかわりにIRCを使ってみる。
HipChatはJabberが使えるのでBitlBeeを使ってJabber経由でIRCと繋ぐことにする。BitlBee自体の設定はなにもいらないので各環境にあわせて適当に入れて起動する。</p>
<pre class="highlight text">sudo emerge bitlbee
sudo /etc/init.d/bitlbee start
</pre>
<p>次にIRCクライアントでBitlBeeに接続する。BitlBeeはlocalhostに6667ポートで立ち上がっているので(コンフィグで修正していなければ)、そこに接続する。文字コードはUTF-8でOK。
接続できたらbitlbeeの部屋でコマンドを入力し、アカウントを追加する。HipChatのJabberのアカウントは「Account Setting &gt; XMPP/Jabber info」にある。</p>
<pre class="highlight text">account add jabber username@chat.hipchat.com &#39;password&#39;
</pre>
<p>次に各ユーザがニックネームで表示されるように設定する。これをやらないと数字の羅列で誰が誰だかわからない状態になってしまう。</p>
<pre class="highlight text">account hipchat set nick_source full_name
</pre>
<p>次にアカウントを有効化する。この時点で認証などもしているので失敗したらアカウント情報を見直すこと。</p>
<pre class="highlight text">account hipchat on
</pre>
<p>有効化できたらすでに部屋に参加できるが数字の羅列が頭についているので使いにくい。別の名前を割り当てることができるので適当に自分が使いやすい名前をつける。</p>
<pre class="highlight text">chat add hipchat room_jaber_name@conf.hipchat.com #channelname
</pre>
<p>ニックの設定次第だとHipChatから怒られるのでその場合HipCHatで使っている名前を設定する。</p>
<pre class="highlight text">channel #channelname set nick &#39;room nickname&#39;
</pre>
<p>無事、部屋にjoinしてログが流れてきたら終了。</p>
<pre class="highlight text">/join #channelname
</pre></div></article><article><h1><a href="/2014/03/13/bittorrentsync_qnap_funtoo/">2014-03-13 BitTorrent SyncでQNAPとFuntooで同期する</a></h1><hr /><div class="article-body"><p>QNAPの一部のディレクトリ(主に電子書籍)とローカルのマシンで同期を取りたかったのでBitTorrent Syncで同期を取ってみる。NFSでもいいんだけど、電子書籍ぐらいならローカルにおけるぐらいのストレージ容量はあるので。</p>

<h2 id="qnapにbittorrent-syncを入れる">QNAPにBitTorrent Syncを入れる</h2>

<p>基本的には<a href="http://www.qnap.com/useng/index.php?sn=9137">QNAPのドキュメント</a>を参照すれば問題ないと思う。簡単に説明しておくとQTSにBitTorrent Syncを追加し、BitTorrent SyncのWebUIを起動する。WebUIのアクセスユーザは途中で&quot;Please modify the Login ID / Password&quot;とか言われる画面でLogin IDとPasswordを入力し、Apply Changesをすればそのユーザで接続できる。</p>

<p>次にBitTorrent SyncのWebUIが起動したらAdd Folderから該当のディレクトリを選択する。Secret KeyはここでGenerateしておく。(後でローカルの方の設定で使用する)。QNAP側はこれで終わり。</p>

<h2 id="funtooにbittorrent-syncを入れる">FuntooにBitTorrent Syncを入れる</h2>

<p>FuntooはportageにBitTorrent Syncのebuildがあるのでそれを使う。</p>
<pre class="highlight text">sudo emerge bittorrent sync
</pre>
<p>起動は<code>/etc/init.d/btsync start</code>だが、コンフィグの修正が必要。init.dで起動するとログがでないからわからないが、<code>/opt/btsync/btsync</code>で起動するとstorage_pathが存在しないと怒られるのがわかる。コンフィグは<code>/etc/btsync/config</code>がそう。</p>
<pre class="highlight text">// &quot;storage_path&quot; : &quot;/home/user/.sync&quot;,
&quot;storage_path&quot; : &quot;/home/ukstudio/.sync&quot;,
</pre>
<p>ディレクトリはお好みで。</p>

<p><code>/etc/init.d/btsync start</code>で無事btsyncが起動したら、<a href="http://localhost:8888/gui%E3%81%A7WebUI%E3%81%AB%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%81%A7%E3%81%8D%E3%82%8B%E3%80%82ID%E3%81%A8%E3%83%91%E3%82%B9%E3%81%AF&#x27;admin&#x27;%E3%81%A8&#x27;password&#x27;%E3%80%82">http://localhost:8888/guiでWebUIにアクセスできる。IDとパスは&#39;admin&#39;と&#39;password&#39;。</a></p>

<p>WebUIにアクセスできたら、Add FolderでQNAPと同期させたいディレクトリを指定する。Secret Keyはここでは生成させず先程のQNAPのsecret keyをコピペする。保存し、WebUIのトップ画面で&quot;connected devices and status&quot;でダウンロード速度が表示されたら無事同期がはじまっている。</p>
</div></article><div class="pager"><ul><li class="previous"><a href="/">Prev</a></li><li class="next"><a href="/page/3/">Next</a></li></ul></div></div></body></html>